{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-body">
        <h2 class="card-title">Content Summary</h2>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <button id="generateSummaryBtn" class="btn btn-primary" onclick="generateSummary()">
                    <i class="bi bi-file-text"></i> Generate Summary
                </button>
                {% if domain_summary %}
                <small class="text-muted ms-2">Last updated: {{ domain_summary.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                {% endif %}
            </div>
            <a href="{{ url_for('data') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Overview
            </a>
        </div>
        
        <div id="summaryLoader" class="d-none">
            <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Analyzing...</span>
                </div>
{% if domain_summary %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const styleToneContent = document.getElementById('styleToneContent');
    const productsServicesContent = document.getElementById('productsServicesContent');
    const icpContent = document.getElementById('icpContent');
    
    if (styleToneContent) {
        styleToneContent.textContent = {{ domain_summary.style_tone|tojson|safe }};
    }
    if (productsServicesContent) {
        productsServicesContent.textContent = {{ domain_summary.products_services|tojson|safe }};
    }
    if (icpContent) {
        icpContent.textContent = {{ domain_summary.icp|tojson|safe }};
    }
});
</script>
{% endif %}
            </div>
        </div>

        <div id="summaryContent" class="{% if not domain_summary %}d-none{% endif %}">
            <div class="analysis-section mb-4">
                <h5 class="mb-3">Website Style & Tone</h5>
                <div id="styleToneContent" class="white-space-pre-wrap"></div>
            </div>

            <div class="analysis-section mb-4">
                <h5 class="mb-3">Products & Services</h5>
                <div id="productsServicesContent" class="white-space-pre-wrap"></div>
            </div>

            <div class="analysis-section">
                <h5 class="mb-3">Ideal Customer Profile (ICP)</h5>
                <div id="icpContent" class="white-space-pre-wrap"></div>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger d-none"></div>
    </div>
</div>

<script>
function generateSummary() {
    const summaryLoader = document.getElementById('summaryLoader');
    const summaryContent = document.getElementById('summaryContent');
    const errorMessage = document.getElementById('errorMessage');
    const generateButton = document.getElementById('generateSummaryBtn');
    
    // Ensure all elements exist before proceeding
    if (!summaryLoader || !summaryContent || !errorMessage || !generateButton) {
        console.error('Required elements not found');
        return;
    }

    // Show loader and disable button
    summaryLoader.classList.remove('d-none');
    generateButton.disabled = true;
    summaryContent.classList.add('d-none');
    errorMessage.classList.add('d-none');

    fetch(`/domain_summary/{{ domain }}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            const styleToneContent = document.getElementById('styleToneContent');
            const productsServicesContent = document.getElementById('productsServicesContent');
            const icpContent = document.getElementById('icpContent');

            if (styleToneContent) {
                styleToneContent.textContent = data.style_tone.join('\n');
            }
            if (productsServicesContent) {
                productsServicesContent.textContent = data.products_services.join('\n\n');
            }
            if (icpContent) {
                icpContent.textContent = data.icp.join('\n\n');
            }

            summaryContent.classList.remove('d-none');
        })
        .catch(error => {
            errorMessage.textContent = `Error generating summary: ${error.message}`;
            errorMessage.classList.remove('d-none');
        })
        .finally(() => {
            summaryLoader.classList.add('d-none');
            generateButton.disabled = false;
        });
}
</script>
{% endblock %}
